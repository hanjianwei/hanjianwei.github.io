<!doctype html><html lang=en-us><head><title>Docker on Mac - Stone Horse</title><meta http-equiv=x-ua-compatible content="ie=edge"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://hanjianwei.com/style.css></head><body><div class=container><header><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Archives</a></li><li><a href=/tags>Tags</a></li></ul></nav></header><main><div class=post><article><h1>Docker on Mac</h1><time>Jun 6, 2014</time><p><p>在虚拟化领域，<a href=https://www.docker.io>Docker</a>是一颗冉冉升起的新星。它构建于<a href=http://en.wikipedia.org/wiki/Lxc>LXC</a>之上，比传统的虚拟机技术相比，它没有操作系统层，因此更加轻量化，灵活性和可移植性也更好。</p><p>Docker有两个主要的部件：daemon和作为客户端的二进制程序「docker」。docker作为客户端，把相应指令发送给daemon来执行。因为Docker使用了Linux内核的一些特性，因此只能运行在具体比较新内核的64位Linux上，其它平台上必须借助虚拟机才能运行。</p><p>在Mac上，主要有两种基于VirtualBox的运行方式：第一种是借助<a href=https://github.com/boot2docker/boot2docker>boot2docker</a>；第二种是使用<a href=http://www.vagrantup.com>Vagrant</a>来管理虚拟机。</p><p>boot2docker使用了一个非常轻量的Linux发行版<a href=https://coreos.com>CoreOS</a>来作为Docker的运行环境，启动很快、占用空间很少。通过<a href=http://brew.sh>Homebrew</a>来安装非常方便：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ brew install boot2docker docker
</code></pre></div><p>boot2docker的一个问题是和Mac之间共享文件非常不方便，官方给出的方案是<a href=https://github.com/boot2docker/boot2docker#folder-sharing>用Samba来共享文件</a>。</p><p>我更喜欢的一种方式是用Vagrant来管理Docker。Vagrant是一个管理虚拟机的软件，1.6版本加入了对<a href=http://www.vagrantup.com/blog/feature-preview-vagrant-1-6-docker-dev-environments.html>Docker的支持</a>，可以在Vagrant中对Docker进行管理。Vagrant可以把<a href=http://docs.vagrantup.com/v2/docker/index.html>Docker作为Provider</a>，在Vagrantfile配置Docker相关的操作。一个简单的Vagrantfile的例子：</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=no>Vagrant</span><span class=o>.</span><span class=n>configure</span><span class=p>(</span><span class=s2>&#34;2&#34;</span><span class=p>)</span> <span class=k>do</span> <span class=o>|</span><span class=n>config</span><span class=o>|</span>
  <span class=n>config</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>provider</span> <span class=s2>&#34;docker&#34;</span> <span class=k>do</span> <span class=o>|</span><span class=n>d</span><span class=o>|</span>
    <span class=n>d</span><span class=o>.</span><span class=n>image</span> <span class=o>=</span> <span class=s2>&#34;ubuntu:14.04&#34;</span>
  <span class=k>end</span>
<span class=k>end</span>
</code></pre></div><p>这个配置文件表示，启动Docker的时候使用<code>ubuntu:14.04</code>这个image。然后，执行操作：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ vagrant up --provider<span class=o>=</span>docker
</code></pre></div><p>在非Linux系统上，Docker是需要运行在虚拟机中的。如果没有配置虚拟机（比如上述例子），Vagrant会自动使用<a href=https://github.com/mitchellh/vagrant/blob/master/plugins/providers/docker/hostmachine/Vagrantfile>boot2docker</a>作为虚拟机。当然，你可以指定一个已有的Vagrantfile作为Docker的运行主机：</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=no>Vagrant</span><span class=o>.</span><span class=n>configure</span><span class=p>(</span><span class=s2>&#34;2&#34;</span><span class=p>)</span> <span class=k>do</span> <span class=o>|</span><span class=n>config</span><span class=o>|</span>
  <span class=n>config</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>provider</span> <span class=s2>&#34;docker&#34;</span> <span class=k>do</span> <span class=o>|</span><span class=n>d</span><span class=o>|</span>
    <span class=n>d</span><span class=o>.</span><span class=n>vagrant_vagrantfile</span> <span class=o>=</span> <span class=s2>&#34;../path/to/Vagrantfile&#34;</span>
  <span class=k>end</span>
<span class=k>end</span>
</code></pre></div><p>同直接使用boot2docker相比，Vagrant提供了非常便捷的手段处理Mac和虚拟机之间的交互，如<a href=http://docs.vagrantup.com/v2/synced-folders/index.html>文件夹同步</a>、<a href=http://docs.vagrantup.com/v2/networking/forwarded_ports.html>端口映射</a>等。在进行文件夹同步时，Vagrant会尝试使用最佳方式进行同步，比如对boot2docker会使用rsync进行同步。</p><p>boot2docker虽然比较精简，但是功能毕竟有限，我使用了一个Ubuntu 14.04来作为Docker的运行主机，相应的Vagrantfile如下：</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=no>VAGRANTFILE_API_VERSION</span> <span class=o>=</span> <span class=s2>&#34;2&#34;</span>

<span class=no>Vagrant</span><span class=o>.</span><span class=n>configure</span><span class=p>(</span><span class=no>VAGRANTFILE_API_VERSION</span><span class=p>)</span> <span class=k>do</span> <span class=o>|</span><span class=n>config</span><span class=o>|</span>
  <span class=c1># Box</span>
  <span class=n>config</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>box</span> <span class=o>=</span> <span class=s2>&#34;phusion/ubuntu-14.04-amd64&#34;</span>
  <span class=n>config</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>box_check_update</span> <span class=o>=</span> <span class=kp>false</span>

  <span class=c1># Provisioners</span>
  <span class=n>config</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>provision</span> <span class=s2>&#34;shell&#34;</span><span class=p>,</span> <span class=ss>path</span><span class=p>:</span> <span class=s2>&#34;apt.sh&#34;</span>
  <span class=n>config</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>provision</span> <span class=s2>&#34;docker&#34;</span>
  <span class=n>config</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>provision</span> <span class=s2>&#34;shell&#34;</span><span class=p>,</span> <span class=ss>path</span><span class=p>:</span> <span class=s2>&#34;docker.sh&#34;</span>

  <span class=n>config</span><span class=o>.</span><span class=n>vm</span><span class=o>.</span><span class=n>network</span> <span class=s2>&#34;forwarded_port&#34;</span><span class=p>,</span> <span class=ss>guest</span><span class=p>:</span> <span class=mi>4243</span><span class=p>,</span> <span class=ss>host</span><span class=p>:</span> <span class=mi>4243</span>
<span class=k>end</span>
</code></pre></div><p>注意中间的<a href=http://docs.vagrantup.com/v2/provisioning/index.html>Provisioner部分</a>，Vagrant的Provisioner的主要作用是自动安装一些软件、执行一些任务。上面的<code>apt.sh</code>是一个脚本，用来修改Ubuntu的apt源；<code>docker.sh</code>用来修改Docker的配置参数。值得注意的是，Vagrant还提供了<a href=http://docs.vagrantup.com/v2/provisioning/docker.html>Docker的Provisoner</a>，用来安装、配置Docker。当你运行的虚拟机中没有安装Docker时，它会自动帮你安装最新的Docker。</p><p>在最后一行，我设置了一个端口映射，将虚拟机的Docker daemon的端口4243映射到本地，这样就可以使用Mac中Homebrew所带的docker客户端来执行相应的操作了（要注意Mac客户端的版本需和虚拟机中Docker daemon的版本一致）。</p><p>我们只要运行<code>vagrant up</code>，Docker的运行环境就搭建好了。Vagrant中有很多对Docker的支持，使得我们能够更方便地自动化搭建开发、部署环境，具体可以参考<a href=http://docs.vagrantup.com/v2/>Vagrant</a>和<a href=http://docs.docker.io>Docker</a>的文档。</p></p></article><aside class=comments><script src=https://utteranc.es/client.js repo=hanjianwei/hanjianwei.github.io issue-term=pathname label=✨💬✨comment theme=github-light crossorigin=anonymous async></script></aside></div></main><footer>&copy; 2013 - 2021 Jianwei Han.
<a href=https://www.github.com/hanjianwei/hanjianwei.github.io/tree/hugo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M278.9 511.5l-61-17.7c-6.4-1.8-10-8.5-8.2-14.9L346.2 8.7c1.8-6.4 8.5-10 14.9-8.2l61 17.7c6.4 1.8 10 8.5 8.2 14.9L293.8 503.3c-1.9 6.4-8.5 10.1-14.9 8.2zm-114-112.2 43.5-46.4c4.6-4.9 4.3-12.7-.8-17.2L117 256l90.6-79.7c5.1-4.5 5.5-12.3.8-17.2l-43.5-46.4c-4.5-4.8-12.1-5.1-17-.5L3.8 247.2c-5.1 4.7-5.1 12.8.0 17.5l144.1 135.1c4.9 4.6 12.5 4.4 17-.5zm327.2.6 144.1-135.1c5.1-4.7 5.1-12.8.0-17.5L492.1 112.1c-4.8-4.5-12.4-4.3-17 .5L431.6 159c-4.6 4.9-4.3 12.7.8 17.2L523 256l-90.6 79.7c-5.1 4.5-5.5 12.3-.8 17.2l43.5 46.4c4.5 4.9 12.1 5.1 17 .6z"/></svg></a><a href=https://www.github.com/hanjianwei><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8.0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8.0-21.5 4.9-32.3 14.6-51.8 45.3.0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8.0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9.0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2.0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8.0-73.5 38.7-73.5 82.6.0 87.8 80.4 101.3 150.4 101.3h48.2c70.3.0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8.0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg></a><a href=https://twitter.com/hanjianwei><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a><a href=mailto:blog@hanjianwei.com><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V4e2c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5.0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></svg></a><a title="PGP Key" href="https://pgp.mit.edu/pks/lookup?op=get&search=0x309B79EC85BB7488"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="key" class="svg-inline--fa fa-key fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M512 176.001C512 273.203 433.202 352 336 352c-11.22.0-22.19-1.062-32.827-3.069l-24.012 27.014A23.999 23.999.0 01261.223 384H224v40c0 13.255-10.745 24-24 24h-40v40c0 13.255-10.745 24-24 24H24c-13.255.0-24-10.745-24-24v-78.059c0-6.365 2.529-12.47 7.029-16.971l161.802-161.802C163.108 213.814 160 195.271 160 176 160 78.798 238.797.001 335.999.0 433.488-.001 512 78.511 512 176.001zM336 128c0 26.51 21.49 48 48 48s48-21.49 48-48-21.49-48-48-48-48 21.49-48 48z"/></svg></a><a href=/index.xml><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328.0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765.0 183.105.0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686.0 38.981.0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"/></svg></a></footer></div></body></html>