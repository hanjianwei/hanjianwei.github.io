<!doctype html><html lang=en-us><head><title>阿里云服务器的Docker配置 - Stone Horse</title><meta http-equiv=x-ua-compatible content="ie=edge"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://hanjianwei.com/style.css></head><body><div class=container><header><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Archives</a></li><li><a href=/tags>Tags</a></li></ul></nav></header><main><div class=post><article><h1>阿里云服务器的Docker配置</h1><time>Jul 30, 2014</time><p><p>最近把程序放到<a href=http://www.aliyun.com>阿里云</a>服务器上，并尝试用<a href=https://www.docker.com>Docker</a>来部署。阿里云的镜像列表里面已经有了Ubuntu 14.04 64位，可以直接<a href=https://docs.docker.com/installation/ubuntulinux/>安装Docker</a>。然而，由于阿里云服务器的特殊情况，需要进行配置才能用。</p><p>安装完Docker之后，发现Docker服务并没有起来，检查日志发现有这么一段：</p><div class=highlight><pre class=chroma><code class=language-plaintext data-lang=plaintext>[/var/lib/docker|3c476c9d] -job init_networkdriver() = ERR (1)
Could not find a free IP address range for interface &#39;docker0&#39;. Please configure its address manually and run &#39;docker -b docker0&#39;
</code></pre></div><p>搜了下Docker的issues，发现<a href=https://github.com/docker/docker/issues/362>这个问题</a>挺多人遇到过。究其原因，要从Docker的启动过程说起，在<a href=https://docs.docker.com/articles/networking/>Docker的文档</a>中有这么一段话：</p><blockquote><p>When Docker starts, it creates a virtual interface named docker0 on the host machine. It randomly chooses an address and subnet from the private range defined by RFC 1918 that are not in use on the host machine, and assigns it to docker0.</p></blockquote><p>也就是说，Docker在启动时，会创建一个虚拟接口<code>docker0</code>，并为其选择一个没有在宿主机器上使用的地址和子网。这个<code>docker0</code>其实并非一般的网络接口，而是一个虚拟的网桥（Ethernet Bridge），其作用是为了容器（Container）和宿主（Host）机器之间的通信。每当Docker启动一个容器时，它都会创建一对对等接口（&ldquo;peer&rdquo; interface）。这对接口有点类似于管道，向其中的一个接口发送数据包，另外一个接口就会接收到。Docker把其中的一个接口分配给容器，作为它的<code>eth0</code>接口；然后，为另外一个接口分配一个唯一的名字比如<code>vethAQI2QT</code>，将其分配给宿主机器，并将其绑定到<code>docker0</code>这个网桥上。这样每个容器都可以和宿主机器进行通信了。</p><p>那么，在阿里云中为什么会启动失败呢？在<a href=https://github.com/docker/docker>Docker的源代码</a>搜索上述错误信息，可以看出问题出在<a href=https://github.com/docker/docker/blob/4398108433121ce2ac9942e607da20fa1680871a/daemon/networkdriver/bridge/driver.go#L246>createBridge</a>这个函数中。该函数会检查<a href=https://github.com/docker/docker/blob/503d124677f5a0221e1bf8c8ed7320a15c5e01db/daemon/networkdriver/bridge/driver.go#L53-L70>下列IP段</a>:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>var</span> <span class=nx>addrs</span> <span class=p>=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
    <span class=s>&#34;172.17.42.1/16&#34;</span><span class=p>,</span>
    <span class=s>&#34;10.0.42.1/16&#34;</span><span class=p>,</span>
    <span class=s>&#34;10.1.42.1/16&#34;</span><span class=p>,</span>
    <span class=s>&#34;10.42.42.1/16&#34;</span><span class=p>,</span>
    <span class=s>&#34;172.16.42.1/24&#34;</span><span class=p>,</span>
    <span class=s>&#34;172.16.43.1/24&#34;</span><span class=p>,</span>
    <span class=s>&#34;172.16.44.1/24&#34;</span><span class=p>,</span>
    <span class=s>&#34;10.0.42.1/24&#34;</span><span class=p>,</span>
    <span class=s>&#34;10.0.43.1/24&#34;</span><span class=p>,</span>
    <span class=s>&#34;192.168.42.1/24&#34;</span><span class=p>,</span>
    <span class=s>&#34;192.168.43.1/24&#34;</span><span class=p>,</span>
    <span class=s>&#34;192.168.44.1/24&#34;</span><span class=p>,</span>
<span class=p>}</span>
</code></pre></div><p>对于每个IP段，Docker会检查它是否和当前机器的域名服务器或路由表有重叠，如果有的话，就放弃该IP段。让我们看看阿里云服务器的路由表：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ route -n
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         121.40.83.247   0.0.0.0         UG    <span class=m>0</span>      <span class=m>0</span>        <span class=m>0</span> eth1
10.0.0.0        10.171.223.247  255.0.0.0       UG    <span class=m>0</span>      <span class=m>0</span>        <span class=m>0</span> eth0
10.171.216.0    0.0.0.0         255.255.248.0   U     <span class=m>0</span>      <span class=m>0</span>        <span class=m>0</span> eth0
121.40.80.0     0.0.0.0         255.255.252.0   U     <span class=m>0</span>      <span class=m>0</span>        <span class=m>0</span> eth1
172.16.0.0      10.171.223.247  255.240.0.0     UG    <span class=m>0</span>      <span class=m>0</span>        <span class=m>0</span> eth0
192.168.0.0     10.171.223.247  255.255.0.0     UG    <span class=m>0</span>      <span class=m>0</span>        <span class=m>0</span> eth0
</code></pre></div><p>检查一下路由表会发现，Docker所检查的IP段在路由表中都有了，所以不能找到一个有效的IP段。</p><p>解决方法其实也很简单，简单粗暴的方法就是把内网的网卡信息直接删掉，它在路由表中所对应的信息也没有了:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ sudo ifconfig eth0 down
</code></pre></div><p>这种方法的缺点也很明显：你就无法访问内网了，而阿里云的内部流量是不收费的（用mirrors.aliyuncs.com来升级不占用公网流量），这点还是比较可惜的。</p><p>另一种方法是把路由表中不用的项删除，这样Docker就能找到能用的IP段了：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ sudo route del -net 172.16.0.0/12
$ sudo service docker start
$ ifconfig docker0
docker0   Link encap:Ethernet  HWaddr 56:84:7a:fe:97:99
          inet addr:172.17.42.1  Bcast:0.0.0.0  Mask:255.255.0.0
</code></pre></div><p>重新启动服务，可以看到<code>docker0</code>已经建立成功，所用的IP地址就是我们删除路由表项之后腾出来的IP地址。采用这种方法，我们仍然可以使用内网的服务。如果要每次启动的时候设置，编辑<code>/etc/network/interfaces</code>，将<code>up route add -net 172.16.0.0 ....</code>那一行删掉即可。</p></p></article><aside class=comments><script src=https://utteranc.es/client.js repo=hanjianwei/hanjianwei.github.io issue-term=pathname label=✨💬✨comment theme=github-light crossorigin=anonymous async></script><div id=disqus_thread></div><script>var disqus_shortname='hjwblog';var disqus_identifier='\/2014\/07\/30\/docker-on-aliyun\/';(function(){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script></aside></div></main><footer>&copy; 2013 - 2020 Jianwei Han.
<a href=https://www.github.com/hanjianwei/hanjianwei.github.io/tree/hugo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M278.9 511.5l-61-17.7c-6.4-1.8-10-8.5-8.2-14.9L346.2 8.7c1.8-6.4 8.5-10 14.9-8.2l61 17.7c6.4 1.8 10 8.5 8.2 14.9L293.8 503.3c-1.9 6.4-8.5 10.1-14.9 8.2zm-114-112.2 43.5-46.4c4.6-4.9 4.3-12.7-.8-17.2L117 256l90.6-79.7c5.1-4.5 5.5-12.3.8-17.2l-43.5-46.4c-4.5-4.8-12.1-5.1-17-.5L3.8 247.2c-5.1 4.7-5.1 12.8.0 17.5l144.1 135.1c4.9 4.6 12.5 4.4 17-.5zm327.2.6 144.1-135.1c5.1-4.7 5.1-12.8.0-17.5L492.1 112.1c-4.8-4.5-12.4-4.3-17 .5L431.6 159c-4.6 4.9-4.3 12.7.8 17.2L523 256l-90.6 79.7c-5.1 4.5-5.5 12.3-.8 17.2l43.5 46.4c4.5 4.9 12.1 5.1 17 .6z"/></svg></a><a href=https://www.github.com/hanjianwei><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8.0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8.0-21.5 4.9-32.3 14.6-51.8 45.3.0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8.0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9.0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2.0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8.0-73.5 38.7-73.5 82.6.0 87.8 80.4 101.3 150.4 101.3h48.2c70.3.0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8.0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg></a><a href=https://twitter.com/hanjianwei><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a><a href=mailto:blog@hanjianwei.com><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V4e2c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5.0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></svg></a><a title="PGP Key" href="https://pgp.mit.edu/pks/lookup?op=get&search=0x309B79EC85BB7488"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="key" class="svg-inline--fa fa-key fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M512 176.001C512 273.203 433.202 352 336 352c-11.22.0-22.19-1.062-32.827-3.069l-24.012 27.014A23.999 23.999.0 01261.223 384H224v40c0 13.255-10.745 24-24 24h-40v40c0 13.255-10.745 24-24 24H24c-13.255.0-24-10.745-24-24v-78.059c0-6.365 2.529-12.47 7.029-16.971l161.802-161.802C163.108 213.814 160 195.271 160 176 160 78.798 238.797.001 335.999.0 433.488-.001 512 78.511 512 176.001zM336 128c0 26.51 21.49 48 48 48s48-21.49 48-48-21.49-48-48-48-48 21.49-48 48z"/></svg></a><a href=/index.xml><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328.0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765.0 183.105.0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686.0 38.981.0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"/></svg></a></footer></div></body></html>