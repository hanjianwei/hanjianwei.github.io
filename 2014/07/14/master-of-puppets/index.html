<!doctype html><html lang=en-us><head><title>èµ°é©¬è§‚èŠ±çœ‹Puppet - Stone Horse</title><meta http-equiv=x-ua-compatible content="ie=edge"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://hanjianwei.com/style.css></head><body><div class=container><header><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Archives</a></li><li><a href=/tags>Tags</a></li></ul></nav></header><main><div class=post><article><h1>èµ°é©¬è§‚èŠ±çœ‹Puppet</h1><time>Jul 14, 2014</time><p><p><a href=http://puppetlabs.com>Puppet</a>æ˜¯ç›®å‰æœ€æµè¡Œçš„ä¸€å¥—<a href=http://en.wikipedia.org/wiki/Configuration_management>é…ç½®ç®¡ç†(Configuration Managementï¼Œç®€ç§°CM)</a>ç³»ç»Ÿã€‚å®ƒæä¾›äº†ä¸€å¥—ç®€æ´ã€å¼ºå¤§çš„æ¡†æ¶ï¼Œä½¿ç³»ç»Ÿç®¡ç†çš„é‡ç”¨ã€åˆ†äº«æ›´åŠ ç®€å•ï¼Œè®©ç³»ç»Ÿé…ç½®æ›´åŠ è‡ªåŠ¨åŒ–ã€‚åœ¨äº‘è®¡ç®—æ—¶ä»£ï¼ŒåŠ¨è¾„éœ€è¦é…ç½®å¤§é‡ä¸»æœºï¼Œå®ƒçš„ä½œç”¨æ›´åŠ æ˜æ˜¾ã€‚</p><p>Puppetä½¿ç”¨ä¸€ç§å£°æ˜å¼çš„è¯­è¨€ï¼Œå’Œä¼ ç»Ÿçš„è„šæœ¬ç›¸æ¯”ï¼Œä½ åªéœ€æŒ‡å®šç›®æ ‡ï¼Œè€Œä¸å¿…å…³æ³¨å…·ä½“çš„æ‰§è¡Œç»†èŠ‚ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦å»ºç«‹ä¸€ä¸ªæ–‡ä»¶<code>/tmp/foobar.txt</code>ï¼Œå…¶å†…å®¹ä¸º<code>Hello World!</code>ï¼Œåœ¨Puppetä¸­è¿™ä¹ˆå†™å°±è¡Œäº†ï¼š</p><div class=highlight><pre class=chroma><code class=language-puppet data-lang=puppet><span class=k>file</span> <span class=p>{</span> <span class=s>&#39;/tmp/foobar.txt&#39;</span><span class=p>:</span><span class=err>
</span><span class=err></span>  <span class=na>ensure</span>  <span class=o>=&gt;</span> <span class=k>present</span><span class=p>,</span><span class=err>
</span><span class=err></span>  <span class=na>content</span> <span class=o>=&gt;</span> <span class=s>&#39;Hello World!&#39;</span><span class=p>,</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span></code></pre></div><p>å°†ä¸Šè¿°å†…å®¹ä¿å­˜ä¸º<code>test.pp</code>ï¼ˆç§°ä¸º<a href=https://docs.puppetlabs.com/pe/latest/puppet_modules_manifests.html#manifests>manifest</a>ï¼‰ï¼Œç„¶åæ‰§è¡Œ<code>puppet apply test.pp</code>ï¼Œå°±ä¼šç¡®ä¿å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶<code>/tmp/foobar.txt</code>ï¼Œå…¶ä¸­çš„å†…å®¹ä¸ºã€ŒHello World!ã€ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒPuppetä¼šæ£€æŸ¥æˆ‘ä»¬å£°æ˜çš„æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œå¦‚æœæ»¡è¶³å°±ä»€ä¹ˆä¹Ÿä¸åšï¼›å¦‚æœä¸æ»¡è¶³å°±æ‰§è¡Œç›¸åº”çš„æ“ä½œä»¥æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹å¯¹ç”¨æˆ·æ¥è¯´æ˜¯å®Œå…¨é€æ˜çš„ï¼Œä½ ä¸ç”¨å†™å„ç§è„šæœ¬å»æ‰§è¡Œå„ç§æ£€æµ‹å’Œä¿®æ”¹ã€‚</p><p>åœ¨Puppetä¸­ï¼Œ<code>file</code>æ˜¯ä¸€ç§<code>èµ„æº(resource)</code>ã€‚<a href=http://docs.puppetlabs.com/puppet/3.6/reference/lang_resources.html>èµ„æº</a>æ˜¯ä¸€ä¸ªç›¸å½“å¹¿çš„æ¦‚å¿µï¼Œç”¨æˆ·ã€è½¯ä»¶åŒ…ã€æ–‡ä»¶ã€æœåŠ¡ç”šè‡³Gitçš„åº“éƒ½æ˜¯èµ„æºï¼Œç”¨<code>puppet describe -l</code>å¯ä»¥æŸ¥çœ‹ç³»ç»Ÿä¸­æ‰€æœ‰çš„èµ„æºç±»å‹ã€‚æ¯ç§èµ„æºéƒ½æœ‰ä¸€ä¸ªç±»å‹ï¼ˆå¦‚<code>file</code>ï¼‰ï¼Œä¸€ä¸ªåå­—ï¼ˆå¦‚<code>/tmp/foobar.txt</code>ï¼‰ä»¥åŠä¸€ç³»åˆ—çš„å±æ€§ï¼ˆå¦‚<code>ensure</code>ã€<code>content</code>ç­‰ï¼‰ï¼Œå¯ä»¥é€šè¿‡<code>puppet describe &lt;resource_type></code>å¾—åˆ°èµ„æºçš„å…·ä½“æè¿°ã€‚</p><p>é€šè¿‡èµ„æºå£°æ˜å°±å¯ä»¥å®Œæˆä¸€äº›åŸºæœ¬çš„ä»»åŠ¡ï¼Œæ¯”å¦‚è¦é…ç½®ä¸€ä¸ªsshæœåŠ¡ï¼š</p><div class=highlight><pre class=chroma><code class=language-puppet data-lang=puppet><span class=c># /root/examples/break_ssh.pp</span><span class=err>
</span><span class=err></span><span class=k>file</span> <span class=p>{</span> <span class=s>&#39;/etc/ssh/sshd_config&#39;</span><span class=p>:</span><span class=err>
</span><span class=err></span>  <span class=na>ensure</span> <span class=o>=&gt;</span> <span class=k>file</span><span class=p>,</span><span class=err>
</span><span class=err></span>  <span class=na>mode</span>   <span class=o>=&gt;</span> <span class=mi>600</span><span class=p>,</span><span class=err>
</span><span class=err></span>  <span class=na>source</span> <span class=o>=&gt;</span> <span class=s>&#39;/root/examples/sshd_config&#39;</span><span class=p>,</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>service</span> <span class=p>{</span> <span class=s>&#39;sshd&#39;</span><span class=p>:</span><span class=err>
</span><span class=err></span>  <span class=na>ensure</span>     <span class=o>=&gt;</span> <span class=k>running</span><span class=p>,</span><span class=err>
</span><span class=err></span>  <span class=na>enable</span>     <span class=o>=&gt;</span> <span class=k>true</span><span class=p>,</span><span class=err>
</span><span class=err></span>  <span class=k>subscribe</span>  <span class=o>=&gt;</span> <span class=k>File</span><span class=p>[</span><span class=s>&#39;/etc/ssh/sshd_config&#39;</span><span class=p>],</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span></code></pre></div><p>å…¶ä¸­å£°æ˜äº†ä¸¤ä¸ªèµ„æºï¼šä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œæƒé™ä¸º<code>600</code>ï¼Œå†…å®¹ä»<code>/root/examples/sshd_config</code>å¤åˆ¶ï¼›ä¸€ä¸ªæœåŠ¡<code>sshd</code>ï¼Œç¡®ä¿å…¶å¤„äºè¿è¡ŒçŠ¶æ€ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸Šè¿°<code>sshd</code>èµ„æºçš„æœ€åä¸€é¡¹æ˜¯<code>subscribe</code>ï¼Œè¿™æ˜¯ä»€ä¹ˆä¸œè¥¿å‘¢ï¼ŸåŸæ¥åœ¨Puppetä¸­ï¼Œæ‰§è¡Œé¡ºåºå¹¶ä¸æ˜¯æŒ‰ç…§èµ„æºçš„å£°æ˜é¡ºåºæ¥çš„ï¼Œåœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œå°±æœ‰å¯èƒ½<code>sshd</code>æœåŠ¡å…ˆå¯åŠ¨èµ·æ¥ï¼Œç„¶åé…ç½®æ–‡ä»¶æ‰ç”Ÿæˆï¼Œè¿™ç§æƒ…å†µé…ç½®æ–‡ä»¶å°±ä¸èµ·ä½œç”¨äº†ã€‚</p><p>Puppetæä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•æ¥<a href=http://docs.puppetlabs.com/learning/ordering.html>ç¡®ä¿èµ„æºçš„æ‰§è¡Œé¡ºåº</a>ï¼Œä¸Šè¿°çš„<code>subscribe</code>å±äº<a href=http://docs.puppetlabs.com/learning/ordering.html#metaparameters-resource-references-and-ordering>metaparameter</a>ï¼Œå®ƒè¡¨ç¤ºå½“é…ç½®æ–‡ä»¶<code>/etc/ssh/sshd_config</code>ä¿®æ”¹åï¼Œè‡ªåŠ¨é‡å¯<code>sshd</code>ã€‚å…¶ä¸­<code>File['/etc/ssh/sshd_config']</code>æ˜¯å¯¹èµ„æºçš„å¼•ç”¨ã€‚é™¤äº†metaparameterä¹‹å¤–ï¼Œè¿˜å¯ä»¥ç”¨<a href=http://docs.puppetlabs.com/learning/ordering.html#chaining-arrows>ç®­å¤´</a>æ¥è¡¨ç¤ºé¡ºåºï¼Œä¸Šè¿°ä¾‹å­ä¹Ÿå¯ä»¥è¿™ä¹ˆå†™ï¼š</p><div class=highlight><pre class=chroma><code class=language-puppet data-lang=puppet><span class=c># /root/examples/break_ssh.pp</span><span class=err>
</span><span class=err></span><span class=k>file</span> <span class=p>{</span> <span class=s>&#39;/etc/ssh/sshd_config&#39;</span><span class=p>:</span><span class=err>
</span><span class=err></span>  <span class=na>ensure</span> <span class=o>=&gt;</span> <span class=k>file</span><span class=p>,</span><span class=err>
</span><span class=err></span>  <span class=na>mode</span>   <span class=o>=&gt;</span> <span class=mi>600</span><span class=p>,</span><span class=err>
</span><span class=err></span>  <span class=na>source</span> <span class=o>=&gt;</span> <span class=s>&#39;/root/examples/sshd_config&#39;</span><span class=p>,</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span><span class=err></span><span class=o>~&gt;</span><span class=err>
</span><span class=err></span><span class=k>service</span> <span class=p>{</span> <span class=s>&#39;sshd&#39;</span><span class=p>:</span><span class=err>
</span><span class=err></span>  <span class=na>ensure</span>     <span class=o>=&gt;</span> <span class=k>running</span><span class=p>,</span><span class=err>
</span><span class=err></span>  <span class=na>enable</span>     <span class=o>=&gt;</span> <span class=k>true</span><span class=p>,</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span></code></pre></div><p>å½“èµ„æºä¸å¤šæ—¶ï¼ŒæŠŠæ‰€æœ‰ä¸œè¥¿éƒ½å†™åˆ°ä¸€ä¸ªå·¨å¤§çš„manifesté‡Œé¢è¿˜å¯ä»¥æ¥å—ï¼›éšç€ä½ ç»´æŠ¤çš„ä¸œè¥¿è¶Šæ¥è¶Šå¤šï¼Œè¿™ç§æ–¹æ³•ä¼šè®©ä½ çš„ä»£ç è¶Šæ¥è¶Šéš¾ç»´æŠ¤ã€‚Puppetæä¾›äº†<a href=http://docs.puppetlabs.com/learning/modules1.html>classå’Œmodule</a>ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿæ›´åŠ æ¨¡å—åŒ–åœ°ç®¡ç†ä»£ç ã€‚</p><p>å¦‚æœä½ åƒæˆ‘ä¸€æ ·ä»å…¶å®ƒç¼–ç¨‹è¯­è¨€è¿‡æ¥ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½ä¼šè¢«classè¿™ä¸ªå…³é”®å­—æ‰€è¿·æƒ‘ï¼šPuppetä¸­çš„classä¸åƒC++æˆ–Javaä¹‹ç±»è¯­è¨€ä¸­çš„classï¼Œå®ƒåªæ˜¯ä¸€æ®µæœ‰åå­—çš„ä»£ç ã€‚ä½ å¯ä»¥ç”¨classæŠŠç›¸å…³çš„ä»£ç åŒ…è£…èµ·æ¥ï¼Œä½¿å…¶é‡ç”¨èµ·æ¥æ›´åŠ æ–¹ä¾¿ã€‚æ¯”å¦‚ä¸Šè¿°ä»£ç å¯ä»¥ä¿®æ”¹ä¸ºï¼š</p><div class=highlight><pre class=chroma><code class=language-puppet data-lang=puppet><span class=k>class</span> <span class=na>ssh</span> <span class=p>{</span><span class=err>
</span><span class=err></span>  <span class=k>file</span> <span class=p>{</span> <span class=s>&#39;/etc/ssh/sshd_config&#39;</span><span class=p>:</span><span class=err>
</span><span class=err></span>    <span class=na>ensure</span> <span class=o>=&gt;</span> <span class=k>file</span><span class=p>,</span><span class=err>
</span><span class=err></span>    <span class=na>mode</span>   <span class=o>=&gt;</span> <span class=mi>600</span><span class=p>,</span><span class=err>
</span><span class=err></span>    <span class=na>source</span> <span class=o>=&gt;</span> <span class=s>&#39;/root/examples/sshd_config&#39;</span><span class=p>,</span><span class=err>
</span><span class=err></span>  <span class=p>}</span><span class=err>
</span><span class=err></span>  <span class=k>service</span> <span class=p>{</span> <span class=s>&#39;sshd&#39;</span><span class=p>:</span><span class=err>
</span><span class=err></span>    <span class=na>ensure</span>     <span class=o>=&gt;</span> <span class=k>running</span><span class=p>,</span><span class=err>
</span><span class=err></span>    <span class=na>enable</span>     <span class=o>=&gt;</span> <span class=k>true</span><span class=p>,</span><span class=err>
</span><span class=err></span>    <span class=k>subscribe</span>  <span class=o>=&gt;</span> <span class=k>File</span><span class=p>[</span><span class=s>&#39;/etc/ssh/sshd_config&#39;</span><span class=p>],</span><span class=err>
</span><span class=err></span>  <span class=p>}</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>include</span> <span class=na>ssh</span><span class=err>
</span></code></pre></div><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œclassåªæ˜¯å®šä¹‰äº†ä¸€æ®µä»£ç ï¼Œåªæœ‰<code>include</code>ä¹‹åæ‰ä¼šå£°æ˜å…¶ä¸­çš„èµ„æºã€‚åŒä¸€ä¸ªclasså¯ä»¥<code>include</code>å¤šæ¬¡ï¼Œæ•ˆæœå’Œ<code>include</code>ä¸€æ¬¡ä¸€æ ·ã€‚ç„¶è€Œï¼Œå³ä½¿æœ‰äº†classï¼Œæˆ‘ä»¬çš„ä»£ç ä»ç„¶åœ¨ä¸€ä¸ªå·¨å¤§çš„manifesté‡Œé¢å•Šï¼è¿™é‡Œå°±è¦æåˆ°<a href=http://docs.puppetlabs.com/learning/modules1.html#modules>module</a>äº†ã€‚</p><p>Moduleå…¶å®å°±æ˜¯ç›®å½•ï¼Œå®ƒæ ¹æ®ç‰¹å®šçš„<a href=http://docs.puppetlabs.com/learning/modules1.html#module-structure>ç»“æ„</a>æ¥ç»„ç»‡ç›®å½•ï¼Œå¹¶ä¸”å…¶ä¸­çš„manifestç¬¦åˆä¸€å®šçš„<a href=http://docs.puppetlabs.com/learning/modules1.html#organizing-and-referencing-manifests>å‘½åè§„åˆ™</a>ã€‚Puppetåœ¨<a href=http://docs.puppetlabs.com/learning/modules1.html#the-modulepath>modulepath</a>ä¸­æœç´¢moduleï¼Œå¦‚æœä¸€ä¸ªç±»åœ¨moduleä¸­å‡ºç°äº†ï¼Œé‚£ä¹ˆä½ å¯ä»¥åœ¨ä»»ä½•å…¶å®ƒçš„manifestä¸­å£°æ˜å®ƒã€‚æ¯”å¦‚è¦é…ç½®ä¸€ä¸ªApacheæœåŠ¡å™¨ï¼Œå¯ä»¥æŠŠapacheä½œä¸ºä¸€ä¸ªæ¨¡å—ï¼Œè€Œmodã€proxyã€vhostçš„è®¾ç½®éƒ½å¯ä»¥ä½œä¸ºå…¶ä¸­çš„manifestã€‚</p><p>Puppetä¸­å¯ä»¥ä½¿ç”¨<a href=http://docs.puppetlabs.com/learning/variables.html>å˜é‡</a>ï¼Œå˜é‡ä»¥<code>$</code>å¼€å¤´ã€‚å˜é‡æ˜¯æœ‰<a href=http://docs.puppetlabs.com/puppet/latest/reference/lang_scope.html>ä½œç”¨åŸŸ</a>çš„ï¼Œå­ä½œç”¨åŸŸå¯ä»¥è®¿é—®çˆ¶ä½œç”¨åŸŸçš„å˜é‡ï¼Œä½†è®¿é—®å…¶å®ƒä½œç”¨åŸŸçš„å˜é‡å°±è¦åŠ ä¸Šmoduleå’Œclasså‰ç¼€ï¼ˆå¦‚<code>$apache::params::confdir</code>ï¼‰ã€‚æ­¤å¤–ï¼Œå˜é‡æ”¯æŒåŒå¼•å·å­—ç¬¦ä¸²æ’å€¼ï¼š<code>"The value is ${variable}"</code>ã€‚</p><p>ä¸Šè¿°ä¾‹å­ä¸­ï¼Œsshé…ç½®æ–‡ä»¶çš„æ¨¡æ¿ä½ç½®æ˜¯å›ºå®šçš„ã€‚ä½†æ˜¯ï¼Œå®é™…åº”ç”¨ä¸­å¾€å¾€æ ¹æ®ä¸åŒçš„æƒ…å†µåšä¿®æ”¹ï¼Œæˆ‘ä»¬ä¸å¯èƒ½é’ˆå¯¹æ¯ç§æƒ…å†µå†™ä¸€ä¸ªclassã€‚ä¸ºæ­¤ï¼Œå¯ä»¥ä½¿ç”¨<a href=http://docs.puppetlabs.com/learning/modules2.html>å¸¦å‚æ•°çš„class</a>ï¼Œä¸Šè¿°ä¾‹å­å¯ä»¥ä¿®æ”¹ä¸ºï¼š</p><div class=highlight><pre class=chroma><code class=language-puppet data-lang=puppet><span class=k>class</span> <span class=na>ssh</span> <span class=p>(</span><span class=nv>$config_path</span> <span class=o>=</span> <span class=s>&#39;/root/examples/ssd_config&#39;</span><span class=p>)</span> <span class=p>{</span><span class=err>
</span><span class=err></span>  <span class=k>file</span> <span class=p>{</span> <span class=s>&#39;/etc/ssh/sshd_config&#39;</span><span class=p>:</span><span class=err>
</span><span class=err></span>    <span class=na>ensure</span> <span class=o>=&gt;</span> <span class=k>file</span><span class=p>,</span><span class=err>
</span><span class=err></span>    <span class=na>mode</span>   <span class=o>=&gt;</span> <span class=mi>600</span><span class=p>,</span><span class=err>
</span><span class=err></span>    <span class=na>source</span> <span class=o>=&gt;</span> <span class=s>&#34;${config_path}&#34;</span><span class=p>,</span><span class=err>
</span><span class=err></span>  <span class=p>}</span><span class=err>
</span><span class=err></span>  <span class=k>service</span> <span class=p>{</span> <span class=s>&#39;sshd&#39;</span><span class=p>:</span><span class=err>
</span><span class=err></span>    <span class=na>ensure</span>     <span class=o>=&gt;</span> <span class=k>running</span><span class=p>,</span><span class=err>
</span><span class=err></span>    <span class=na>enable</span>     <span class=o>=&gt;</span> <span class=k>true</span><span class=p>,</span><span class=err>
</span><span class=err></span>    <span class=k>subscribe</span>  <span class=o>=&gt;</span> <span class=k>File</span><span class=p>[</span><span class=s>&#39;/etc/ssh/sshd_config&#39;</span><span class=p>],</span><span class=err>
</span><span class=err></span>  <span class=p>}</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>class</span> <span class=p>{</span> <span class=s>&#39;ssh&#39;</span><span class=p>:</span><span class=err>
</span><span class=err></span>  <span class=na>config_path</span> <span class=o>=&gt;</span> <span class=s>&#39;/home/jack/ssd_config&#39;</span><span class=p>,</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span></code></pre></div><p>æ³¨æ„è¦ä½¿ç”¨å¸¦å‚æ•°çš„classï¼Œå°±ä¸èƒ½ç›´æ¥ç”¨<code>include ssh</code>ï¼ˆå¦åˆ™ä¼šä½¿ç”¨é»˜è®¤å‚æ•°ï¼‰ï¼Œè€Œæ˜¯è¦ç”¨èµ„æºå¼çš„classå£°æ˜æ–¹å¼ï¼Œå°†å‚æ•°ä½œä¸ºå±æ€§ä¼ é€’è¿›å»ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹åº”è¯¥ä»”ç»†ç»„ç»‡manifestæ–‡ä»¶ï¼Œä¸è¦å°†ä¸€ä¸ªclasså£°æ˜ä¸¤æ¬¡ã€‚å‚æ•°ç±»çš„å¦å¤–ä¸€ç§ä½¿ç”¨æ–¹æ³•æ˜¯é€šè¿‡<a href=http://docs.puppetlabs.com/hiera/1/puppet.html>Hiera</a>æ¥è®¾ç½®å‚æ•°ï¼Œè¿™ç§æ–¹å¼èƒ½å¤Ÿå°½é‡æŠŠä»£ç å’Œæ•°æ®åˆ†å¼€ï¼Œæ˜¯ä¸€ç§æ¨èçš„ä½¿ç”¨æ–¹å¼ã€‚</p><p>å³ä½¿classå¯ä»¥è®¾ç½®å‚æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿåªèƒ½è®¾ç½®ä¸€ç»„å‚æ•°ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦åŒæ—¶è®¾ç½®å¤šç»„å‚æ•°å‘¢ï¼Ÿæ¯”å¦‚Apacheçš„vhostï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿè®¾ç½®å¤šä¸ªvhostï¼Œæ¯”å¦‚ï¼š</p><div class=highlight><pre class=chroma><code class=language-puppet data-lang=puppet><span class=na>apache</span><span class=p>::</span><span class=na>vhost</span> <span class=p>{</span><span class=s>&#39;users.example.com&#39;</span><span class=p>:</span><span class=err>
</span><span class=err></span>  <span class=na>port</span>    <span class=o>=&gt;</span> <span class=mi>80</span><span class=p>,</span><span class=err>
</span><span class=err></span>  <span class=na>docroot</span> <span class=o>=&gt;</span> <span class=s>&#39;/var/www/personal&#39;</span><span class=p>,</span><span class=err>
</span><span class=err></span>  <span class=na>options</span> <span class=o>=&gt;</span> <span class=s>&#39;Indexes MultiViews&#39;</span><span class=p>,</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span><span class=err></span><span class=na>apache</span><span class=p>::</span><span class=na>vhost</span> <span class=p>{</span><span class=s>&#39;projects.example.com&#39;</span><span class=p>:</span><span class=err>
</span><span class=err></span>  <span class=na>port</span>    <span class=o>=&gt;</span> <span class=mi>80</span><span class=p>,</span><span class=err>
</span><span class=err></span>  <span class=na>docroot</span> <span class=o>=&gt;</span> <span class=s>&#39;/var/www/project&#39;</span><span class=p>,</span><span class=err>
</span><span class=err></span>  <span class=na>options</span> <span class=o>=&gt;</span> <span class=s>&#39;Indexes MultiViews&#39;</span><span class=p>,</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span></code></pre></div><p>è¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦defineç±»å‹äº†ï¼Œå®ƒæ‰€å®šä¹‰çš„ç±»å‹å’Œç³»ç»Ÿæä¾›çš„èµ„æºç±»ä¼¼ï¼Œå¯ä»¥åŒæ—¶å£°æ˜å¤šä¸ªä¸åŒå‚æ•°çš„èµ„æºã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><div class=highlight><pre class=chroma><code class=language-puppet data-lang=puppet><span class=k>define</span> <span class=na>planfile</span> <span class=p>(</span><span class=nv>$user</span> <span class=o>=</span> <span class=nv>$title,</span> <span class=nv>$content)</span> <span class=p>{</span><span class=err>
</span><span class=err></span>  <span class=k>file</span> <span class=p>{</span><span class=s>&#34;/home/${user}/.plan&#34;</span><span class=p>:</span><span class=err>
</span><span class=err></span>    <span class=na>ensure</span>  <span class=o>=&gt;</span> <span class=k>file</span><span class=p>,</span><span class=err>
</span><span class=err></span>    <span class=na>content</span> <span class=o>=&gt;</span> <span class=nv>$content,</span><span class=err>
</span><span class=err></span>    <span class=na>mode</span>    <span class=o>=&gt;</span> <span class=mo>0644</span><span class=p>,</span><span class=err>
</span><span class=err></span>    <span class=na>owner</span>   <span class=o>=&gt;</span> <span class=nv>$user,</span><span class=err>
</span><span class=err></span>    <span class=na>require</span> <span class=o>=&gt;</span> <span class=k>User</span><span class=p>[</span><span class=nv>$user],</span><span class=err>
</span><span class=err></span>  <span class=p>}</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span><span class=err></span><span class=na>planfile</span> <span class=p>{</span><span class=s>&#39;nick&#39;</span><span class=p>:</span><span class=err>
</span><span class=err></span>  <span class=na>content</span> <span class=o>=&gt;</span> <span class=s>&#34;working on foobar&#34;</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span><span class=err></span><span class=na>planfile</span> <span class=p>{</span><span class=s>&#39;katie&#39;</span><span class=p>:</span><span class=err>
</span><span class=err></span>  <span class=na>content</span> <span class=o>=&gt;</span> <span class=s>&#34;working on cookies&#34;</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span></code></pre></div><p>è¦å‘æŒ¥Puppetæœ€å¤§çš„ä¼˜åŠ¿ï¼Œå¿…é¡»äº†è§£<a href=http://docs.puppetlabs.com/learning/agent_master_basic.html>Agent/Master Puppet</a>ï¼ˆä¸ºä»€ä¹ˆç°åœ¨éƒ½ä¸ç”¨Master/Slaveäº†ï¼Ÿçœ‹<a href=https://github.com/django/django/pull/2692>è¿™é‡Œ</a>ï¼‰ã€‚ä¸è¿‡æˆ‘æš‚æ—¶éƒ½æ˜¯å•æœºç”¨ç”¨ï¼Œå°±å…ˆä¸å»äº†è§£äº†ã€‚</p><p>å½“ç„¶äº†ï¼Œé¢˜ç›®å°±å«èµ°é©¬è§‚èŠ±ï¼Œçœ‹è¿™ç¯‡Blogä½ æ˜¯ä¸å¯èƒ½å®Œå…¨æŒæ¡Puppetçš„å•¦ï¼Œæ„Ÿå…´è¶£å°±å»çœ‹çœ‹<a href=https://puppetlabs.com/download-learning-vm>tutorial</a>å’Œ<a href=http://docs.puppetlabs.com/puppet/latest/reference/>reference</a>å§ï¼</p></p></article><aside class=comments><script src=https://utteranc.es/client.js repo=hanjianwei/hanjianwei.github.io issue-term=pathname label=âœ¨ğŸ’¬âœ¨comment theme=github-light crossorigin=anonymous async></script><div id=disqus_thread></div><script>var disqus_shortname='hjwblog';var disqus_identifier='\/2014\/07\/14\/master-of-puppets\/';(function(){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script></aside></div></main><footer>&copy; 2013 - 2020 Jianwei Han.
<a href=https://www.github.com/hanjianwei/hanjianwei.github.io/tree/hugo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M278.9 511.5l-61-17.7c-6.4-1.8-10-8.5-8.2-14.9L346.2 8.7c1.8-6.4 8.5-10 14.9-8.2l61 17.7c6.4 1.8 10 8.5 8.2 14.9L293.8 503.3c-1.9 6.4-8.5 10.1-14.9 8.2zm-114-112.2 43.5-46.4c4.6-4.9 4.3-12.7-.8-17.2L117 256l90.6-79.7c5.1-4.5 5.5-12.3.8-17.2l-43.5-46.4c-4.5-4.8-12.1-5.1-17-.5L3.8 247.2c-5.1 4.7-5.1 12.8.0 17.5l144.1 135.1c4.9 4.6 12.5 4.4 17-.5zm327.2.6 144.1-135.1c5.1-4.7 5.1-12.8.0-17.5L492.1 112.1c-4.8-4.5-12.4-4.3-17 .5L431.6 159c-4.6 4.9-4.3 12.7.8 17.2L523 256l-90.6 79.7c-5.1 4.5-5.5 12.3-.8 17.2l43.5 46.4c4.5 4.9 12.1 5.1 17 .6z"/></svg></a><a href=https://www.github.com/hanjianwei><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8.0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8.0-21.5 4.9-32.3 14.6-51.8 45.3.0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8.0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9.0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2.0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8.0-73.5 38.7-73.5 82.6.0 87.8 80.4 101.3 150.4 101.3h48.2c70.3.0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8.0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg></a><a href=https://twitter.com/hanjianwei><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a><a href=mailto:blog@hanjianwei.com><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V4e2c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5.0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></svg></a><a title="PGP Key" href="https://pgp.mit.edu/pks/lookup?op=get&search=0x309B79EC85BB7488"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="key" class="svg-inline--fa fa-key fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M512 176.001C512 273.203 433.202 352 336 352c-11.22.0-22.19-1.062-32.827-3.069l-24.012 27.014A23.999 23.999.0 01261.223 384H224v40c0 13.255-10.745 24-24 24h-40v40c0 13.255-10.745 24-24 24H24c-13.255.0-24-10.745-24-24v-78.059c0-6.365 2.529-12.47 7.029-16.971l161.802-161.802C163.108 213.814 160 195.271 160 176 160 78.798 238.797.001 335.999.0 433.488-.001 512 78.511 512 176.001zM336 128c0 26.51 21.49 48 48 48s48-21.49 48-48-21.49-48-48-48-48 21.49-48 48z"/></svg></a><a href=/index.xml><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328.0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765.0 183.105.0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686.0 38.981.0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"/></svg></a></footer></div></body></html>