<!doctype html><html lang=en-us><head><title>一袋烟功夫构建Mac环境 - Stone Horse</title><meta http-equiv=x-ua-compatible content="ie=edge"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://hanjianwei.com/style.css></head><body><div class=container><header><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Archives</a></li><li><a href=/tags>Tags</a></li></ul></nav></header><main><div class=post><article><h1>一袋烟功夫构建Mac环境</h1><time>Jul 15, 2014</time><p><p>最近硬盘不幸挂掉，换了新硬盘后重装系统、搭建环境真是一个痛苦的过程。尤其是后者，各种软件的配置、开发环境的设定，非常繁琐。这里索性总结一下，怎么能够将开发、应用的环境配置系统化，使得更换系统时能够迅速重建原来的环境。这里虽然是针对Mac来说的，对于Linux应该也类似。</p><p>作为一个开发者用户，我关心的数据主要有以下几类：</p><ol><li>代码</li><li>各种资料、数据（照片、视频、文档、程序数据等）</li><li>应用程序及其配置信息</li><li>系统配置信息</li></ol><p>对于代码而言，如果是开源的，放在GitHub是最好的方案；如果是内部代码，可以考虑用<a href=https://about.gitlab.com>GitLab</a>搭建一个私有服务器来存放代码，当然也可以放在Dropbox之类的网盘上。对于资料文档以及比较大的数据，可以放在网盘上。无论是代码还是文档，除了网上存储之外，最好能定期备份到移动硬盘上，一来是防止网盘出问题，二来是大数据从网盘下载较慢，如果急用就比较痛苦了。所以这里我们主要侧重于后面两点：应用程序的安装配置及系统的配置。</p><h3 id=使用homebrew管理程序>使用Homebrew管理程序</h3><p>Mac中的App主要有两类：一类是从App Store中安装的；另一类是下载安装的。对于前者，没有什么太好的办法，到Purchased里面一个个重新装过就好了；对于后者，用<a href=http://brew.sh>Homebrew</a>来管理更加方便，相比直接的下载安装而言，它是更容易自动化、更易重现的方式。</p><p>对于dmg和pkg程序，可以用<a href=http://caskroom.io>Homebrew Cask</a>来安装。</p><p>如果要装的程序没有在Homebrew或者Cask里面，可以在你的GitHub中<a href=https://github.com/hanjianwei/homebrew-apps>建立一个Repo</a>来存放相关的Formula/Cask，然后用<a href=https://github.com/Homebrew/homebrew/wiki/brew-tap>brew tap</a>将其加到Homebrew中。</p><p>Homebrew的好处是，你很容易将当前安装的程序列表<a href=http://www.topbug.net/blog/2013/12/07/back-up-homebrew-packages/>备份</a>起来以备下次安装。另外一种备份方法是采用<a href=https://coderwall.com/p/afmnbq>Brewfile</a>，不过Homebrew<a href=https://github.com/Homebrew/homebrew/pull/30749>已经后悔把这东西加进去了</a>，以后也许会有更好的方案出现吧。</p><h3 id=管理配置文件>管理配置文件</h3><p>安装程序其实只是最简单的一步，更麻烦的是如何对这些程序进行配置。当前一个很流行的方式是把你的配置文件放在一个<a href=http://dotfiles.github.io>Dotfiles</a>的<a href=https://github.com/hanjianwei/dotfiles>Repo</a>里，然后将其符号链接到相应的位置。然后你就可以用Git轻松管理你的配置文件了。对于包含敏感信息无法放在GitHub中的信息，也可以放在Dropbox中。</p><p>把所有程序的配置文件都搜集起来当然是一件非常繁琐的事情，而<a href=https://github.com/lra/mackup>Mackup</a>可以把你从这件事情里面解放出来，它记录了很多程序的配置文件，从而能够自动在系统中搜索这些配置文件，备份到你的目录中，然后再符号链接到相应的位置。结合GitHub或者Dropbox来进行备份，真是太方便了！</p><p>Dotfiles中还可以保存一些常用的脚本，比如<a href=https://github.com/mathiasbynens/dotfiles/blob/master/.osx>mathiasbynens的dotfiles</a>中就包含了很多OSX的设置脚本，一键运行完成你大部分的系统设置。</p><p>然而，单靠配置文件有时候也不能完全解决问题，比如安装vim的时候，希望不但能保留.vimrc之类的配置文件，还希望能把所有的插件装上去。这时候就需要介绍下面一个系统了：Boxen。</p><h3 id=用boxen自动化环境设置>用Boxen自动化环境设置</h3><p><a href=https://boxen.github.com>Boxen</a>是GitHub的自动化部署工具，它能够快速为新员工构建一个开发环境。Boxen基于<a href=https://puppetlabs.com>Puppet</a>，它针对Mac系统做了一系列的设置，使得环境配置更加方便快捷。关于Boxen的介绍可以看看<a href=http://garylarizza.com/blog/2013/02/15/puppet-plus-github-equals-laptop-love/>Gary Larizza的这篇博客</a>.</p><p>GitHub提供了一个Boxen工程的模板，叫做<a href=https://github.com/boxen/our-boxen>our-boxen</a>，只要将其fork并安装<a href=https://github.com/boxen/our-boxen#getting-started>说明文档</a>安装即可。安装完的our-boxen包含了一个基本的开发环境（Ruby、node等），你可以在此基础上加入你自己的东西。一般来说，你可以在modules目录里面添加相关的内容：people添加和用户相关的内容，projects中添加工程相关的内容。我的个人设置在<a href=https://github.com/hanjianwei/my-boxen/tree/master/modules/people/manifests>这里</a>。</p><p>对系统默认参数的一些配置（比如全局的Ruby版本）可以通过Hiera实现，具体参考<a href=https://github.com/hanjianwei/my-boxen/blob/master/hiera/common.yaml.example>相关说明</a>。你可以针对用户进行一些设置，<a href=https://github.com/hanjianwei/my-boxen/blob/master/hiera/users/hanjianwei.yaml>这里</a>是我的个人设置。</p><p>你甚至可以把<a href=https://github.com/hanjianwei/my-boxen/blob/master/modules/people/manifests/hanjianwei/repositories.pp>代码的Repo</a>和<a href=https://github.com/hanjianwei/my-boxen/blob/master/modules/people/manifests/hanjianwei/osx.pp>系统相关的配置</a>写在文件里，下次部署时直接搞定。</p><p>Boxen支持Homebrew/Cask，所以我们上面<a href=https://github.com/hanjianwei/my-boxen/blob/master/modules/people/manifests/hanjianwei/applications.pp>安装的App可以直接写文件中</a>，下次部署时只要一个<code>boxen</code>命令即可。Boxen自身也只是App的安装，其<a href=https://github.com/boxen>GitHub帐户</a>中包含了很多可用的App，和Homebrew/Cask相比，这些App的更新可能相对较慢，但一般会提供更多的配置选项。对于简单的的应用，我一般使用Homebrew/Cask来管理，对于配置比较复杂的（如Ruby）我会采用Boxen提供的版本。</p><p>此外，我写了一个puppet的模块<a href=https://github.com/hanjianwei/puppet-dotfiles>puppet-dotfiles</a>，可以使用Mackup兼容的配置文件，直接在Boxen工程中进行配置，使得程序的配置更加自动化。该模块除了用Mackup的配置文件，还会进行了一些其它的设置，比如安装vim的时候会安装上<a href=https://github.com/gmarik/Vundle.vim>Vundle</a>及其它插件、自动安装<a href=https://github.com/sorin-ionescu/prezto>prezto</a>及其模块等。</p><p>Boxen的另外一个好处是删除简单，只要把<code>/opt/boxen</code>删除即可（当然可能你还要删除<code>/opt</code>下的<code>homebrew-cask</code>之类的）。</p><h3 id=缓存安装文件>缓存安装文件</h3><p>虽然上述过程能够大大减轻你的负担，但是在恶劣的网络环境中，下载安装文件就会成为一个瓶颈。我的解决方案是：缓存安装文件。</p><p>Homebrew/Cask安装程序时会把安装文件缓存下来，下次重装的时候就不会再次下载了。我的Mac是11年的型号，光驱位换了SSD，所以就把这些缓存文件备份到原来的硬盘：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ mv <span class=sb>`</span>brew --cache<span class=sb>`</span> <span class=s2>&#34;/Volumes/Macintosh HD/&#34;</span>
$ ln -s <span class=s2>&#34;/Volumes/Macintosh HD/cache&#34;</span> <span class=sb>`</span>brew --cache<span class=sb>`</span>
</code></pre></div><p>这样万一SSD坏掉，重装起来也会比较快一点。</p><p>当然，编译也是一项非常耗时的任务，这个问题主要存在Homebrew中（因为Cask只是些dmg、pkg）。不过Homebrew非常佛心地提供了编译好的二进制版本（叫做<a href=https://github.com/Homebrew/homebrew/wiki/Bottles#bottle-creation>Bottle</a>），只要你用默认选项安装，就会使用二进制版本，免去你的编译之苦。然而，不幸的是，某些程序的编译过程需要具体的路径信息（比如Qt），Homebrew默认是安装在<code>/usr/local</code>的，而Boxen把Homebrew安装在了<code>/opt/boxen/homebrew</code>中，所以就<a href=https://github.com/boxen/puppet-homebrew/issues/8>不能享受到这项好处了</a>，希望将来能够有所改进吧！</p><h3 id=其它方案>其它方案</h3><p>对于这样一个常见问题，肯定是有很多方案的，这里有一些供参考的其它方案：</p><ul><li><a href=http://osxc.github.io>osxc</a>: 基于<a href=http://osxc.github.io>Ansible</a>的一套方案。</li><li><a href=https://github.com/spencergibb/battleschool>battleschool</a>: 也是基于Ansible的方案。</li><li><a href=https://github.com/kitchenplan/kitchenplan>kitchenplan</a>: 基于<a href=http://www.getchef.com>Chef</a>的方案。</li><li><a href=https://github.com/thoughtbot/laptop>thoughtbot/laptop</a>: 用于Mac和Linux安装配置的一套脚本。</li></ul><p>其实还有很多……<a href=https://github.com/hanjianwei/feedback/issues/new>说说你的方案吧</a>。</p></p></article><aside class=comments><div id=disqus_thread></div></aside><script>var disqus_shortname='hjwblog';var disqus_identifier='\/2014\/07\/15\/1-click-building-your-mac-environment\/';(function(){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script></div></main><footer>&copy; 2013 - 2020 Jianwei Han.
<a href=https://www.github.com/hanjianwei/hanjianwei.github.io/tree/hugo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M278.9 511.5l-61-17.7c-6.4-1.8-10-8.5-8.2-14.9L346.2 8.7c1.8-6.4 8.5-10 14.9-8.2l61 17.7c6.4 1.8 10 8.5 8.2 14.9L293.8 503.3c-1.9 6.4-8.5 10.1-14.9 8.2zm-114-112.2 43.5-46.4c4.6-4.9 4.3-12.7-.8-17.2L117 256l90.6-79.7c5.1-4.5 5.5-12.3.8-17.2l-43.5-46.4c-4.5-4.8-12.1-5.1-17-.5L3.8 247.2c-5.1 4.7-5.1 12.8.0 17.5l144.1 135.1c4.9 4.6 12.5 4.4 17-.5zm327.2.6 144.1-135.1c5.1-4.7 5.1-12.8.0-17.5L492.1 112.1c-4.8-4.5-12.4-4.3-17 .5L431.6 159c-4.6 4.9-4.3 12.7.8 17.2L523 256l-90.6 79.7c-5.1 4.5-5.5 12.3-.8 17.2l43.5 46.4c4.5 4.9 12.1 5.1 17 .6z"/></svg></a><a href=https://www.github.com/hanjianwei><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8.0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8.0-21.5 4.9-32.3 14.6-51.8 45.3.0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8.0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9.0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2.0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8.0-73.5 38.7-73.5 82.6.0 87.8 80.4 101.3 150.4 101.3h48.2c70.3.0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8.0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg></a><a href=https://twitter.com/hanjianwei><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a><a href=mailto:blog@hanjianwei.com><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V4e2c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5.0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></svg></a><a title="PGP Key" href="https://pgp.mit.edu/pks/lookup?op=get&search=0x309B79EC85BB7488"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="key" class="svg-inline--fa fa-key fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M512 176.001C512 273.203 433.202 352 336 352c-11.22.0-22.19-1.062-32.827-3.069l-24.012 27.014A23.999 23.999.0 01261.223 384H224v40c0 13.255-10.745 24-24 24h-40v40c0 13.255-10.745 24-24 24H24c-13.255.0-24-10.745-24-24v-78.059c0-6.365 2.529-12.47 7.029-16.971l161.802-161.802C163.108 213.814 160 195.271 160 176 160 78.798 238.797.001 335.999.0 433.488-.001 512 78.511 512 176.001zM336 128c0 26.51 21.49 48 48 48s48-21.49 48-48-21.49-48-48-48-48 21.49-48 48z"/></svg></a><a href=/index.xml><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328.0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765.0 183.105.0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686.0 38.981.0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"/></svg></a></footer></div></body></html>