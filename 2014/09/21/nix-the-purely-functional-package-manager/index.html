<!doctype html><html lang=en-us><head><title>Nix: 纯函数式包管理器 - Stone Horse</title><meta http-equiv=x-ua-compatible content="ie=edge"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://hanjianwei.com/style.css></head><body><div class=container><header><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Archives</a></li><li><a href=/tags>Tags</a></li></ul></nav></header><main><div class=post><article><h1>Nix: 纯函数式包管理器</h1><time>Sep 21, 2014</time><p><p><a href=http://nixos.org/nix/>Nix</a>是一个Linux/Unix下的<a href=https://en.wikipedia.org/wiki/Package_management_system>包管理器</a>，它支持原子升级和回滚、能够同时安装同一个包的多个版本、支持多用户，能够更加简单地搭建开发、构建环境。它最大的卖点在于 <em>函数式</em> 的管理方式：把软件包作为函数式语言的值，这些值由没有副作用的函数构建，一旦构建完就不再改变，这意味着你的软件运行环境一旦构建就不会改变——这对于可重现的开发而言非常重要。</p><h3 id=安装>安装</h3><p>如果你想充分体验Nix的强大功能，可以安装<a href=http://nixos.org>NixOS</a>，它是一个构建于Nix之上的Linux发型版。</p><p>如果你不想装一个新的系统，或者像我一样主要用Mac OSX工作，也可以只安装Nix。最简单的方式就是在Terminal里面执行如下命令：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ bash &lt;<span class=o>(</span>curl https://nixos.org/nix/install<span class=o>)</span>
</code></pre></div><p>然后把下面这段脚本加入到你的shell启动文件中(<code>~/.zshrc</code>、<code>~/.bashrc</code>等)：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=k>if</span> <span class=o>[</span> -e <span class=nv>$HOME</span>/.nix-profile/etc/profile.d/nix.sh <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
  <span class=nb>source</span> <span class=nv>$HOME</span>/.nix-profile/etc/profile.d/nix.sh<span class=p>;</span>
<span class=k>fi</span>
</code></pre></div><p>然后就可以查看有什么可用的包：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>
$ nix-env -qa
</code></pre></div><p>安装一个包：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ nix-env -i hello
</code></pre></div><p>卸载一个包：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ nix-env -e hello
</code></pre></div><p>升级所有的包：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ nix-channel --update nixpkgs
$ nix-env -u <span class=s1>&#39;*&#39;</span>
</code></pre></div><p>回滚上一步操作：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ nix-env --rollback
</code></pre></div><p>垃圾回收不用的包：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ nix-collect-garbage -d
</code></pre></div><h3 id=包管理>包管理</h3><p>安装Nix时主要创建了两个目录：<code>/nix</code>和<code>$HOME/.nix-profile</code>。我们来看看安装的包到底是如何组织的，比如当前有一个包<code>hello</code>：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ which hello
/Users/hjw/.nix-profile/bin/hello
</code></pre></div><p>可以看到，<code>hello</code>来自于<code>$HOME/.nix-profile</code>，而后者是一个符号链接，其指向如下：</p><p><img src=nix-profile.svg alt="Nix profile"></p><p>进一步查看最后一个目录（省略部分输出）：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ ls -l /nix/store/hsw97dr9h9z3wmlwhx2lib8r3k2f9wv3-user-environment
bin
etc -&gt; /nix/store/2vk1g8qkly4aqwx6ks49mzkd5kxhrd5f-nix-1.8pre3766_809ca33/etc
include -&gt; /nix/store/2vk1g8qkly4aqwx6ks49mzkd5kxhrd5f-nix-1.8pre3766_809ca33/include
……

$ ls -l /nix/store/hsw97dr9h9z3wmlwhx2lib8r3k2f9wv3-user-environment/bin
ccmake -&gt; /nix/store/r5rr3h6fg9sb0vararwh3plm2v9p8hcm-cmake-2.8.12.2/bin/ccmake
cmake -&gt; /nix/store/r5rr3h6fg9sb0vararwh3plm2v9p8hcm-cmake-2.8.12.2/bin/cmake
……
</code></pre></div><p>可以发现，实际的文件都是存在<code>/nix/store</code>中的。这也是Nix管理包的方式：所有的包都存放在<code>/nix/store</code>中，而用户访问的都是指向<code>/nix/store</code>中文件的符号链接。</p><p>Profile是Nix管理包的方式，在<code>/nix/var/nix/profiles</code>中保存了当前的profile：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ ls -l /nix/var/nix/profiles
default -&gt; default-6-link
default-5-link -&gt; /nix/store/g7l19z0c0ka41irwkn4mz67a0z85xydg-user-environment
default-6-link -&gt; /nix/store/hsw97dr9h9z3wmlwhx2lib8r3k2f9wv3-user-environment
per-user
</code></pre></div><p>其中<code>default</code>就是当前的profile。如果我们删除一个包呢？</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ nix-env -e hello
uninstalling ‘hello-2.9’
building path<span class=o>(</span>s<span class=o>)</span> ‘/nix/store/816saagv6v8s19b2sksbgzjj0ljf5qfk-user-environment’
created <span class=m>62</span> symlinks in user environment

$ ls -l /nix/var/nix/profiles
default -&gt; default-7-link
default-5-link -&gt; /nix/store/g7l19z0c0ka41irwkn4mz67a0z85xydg-user-environment
default-6-link -&gt; /nix/store/hsw97dr9h9z3wmlwhx2lib8r3k2f9wv3-user-environment
default-7-link -&gt; /nix/store/816saagv6v8s19b2sksbgzjj0ljf5qfk-user-environment
per-user
</code></pre></div><p>注意到删除一个包会生成一个新的profile —— <code>default-7-link</code>，而<code>default</code>也会指向新生成的profile。这也是Nix的工作方式，你删除包的时候，包其实并没有被删除，而是生成了一个不包含原来包的新profile！而你随时可以回到原来的状态。如果我们后悔删除<code>hello</code>了，那么可以回滚上述操作：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ which hello
hello not found
$ nix-env --rollback
switching from generation <span class=m>7</span> to <span class=m>6</span>
$ which hello
/Users/hjw/.nix-profile/bin/hello
$ ls -l /nix/var/nix/profiles
default -&gt; default-6-link
default-5-link -&gt; /nix/store/g7l19z0c0ka41irwkn4mz67a0z85xydg-user-environment
default-6-link -&gt; /nix/store/hsw97dr9h9z3wmlwhx2lib8r3k2f9wv3-user-environment
default-7-link -&gt; /nix/store/816saagv6v8s19b2sksbgzjj0ljf5qfk-user-environment
per-user
</code></pre></div><p>可以看到，回滚之后<code>default</code>又指向了<code>default-6-link</code>，<code>hello</code>又可以用了。Profile使用起来非常灵活，我们可以很方便地在各个profile之间切换：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ nix-env --list-generations
   <span class=m>5</span>   2014-09-13 20:58:33
   <span class=m>6</span>   2014-09-19 10:00:58   <span class=o>(</span>current<span class=o>)</span>
   <span class=m>7</span>   2014-09-21 21:16:57
$ nix-env --switch-generation <span class=m>7</span>
switching from generation <span class=m>6</span> to <span class=m>7</span>
$ nix-env --switch-profile /nix/var/nix/profiles/my-profile
$ ls -l ~/.nix-profile
/Users/hjw/.nix-profile -&gt; /nix/var/nix/profiles/my-profile
</code></pre></div><p>如果我们从来不真正删除包，毫无疑问硬盘慢慢就会被占满，Nix支持垃圾回收。我们需要首先删除不用的profile：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ nix-env --delete-generations <span class=m>5</span>
removing generation <span class=m>5</span>
$ nix-env --delete-generations old
removing generation <span class=m>6</span>
$ nix-env --list-generations
   <span class=m>7</span>   2014-09-21 21:16:57   <span class=o>(</span>current<span class=o>)</span>
</code></pre></div><p>然后，可以运行垃圾回收的命令。这里的垃圾回收跟编程语言的垃圾回收机制很像，一个包如果没有profile用到它就会被删除：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ nix-store --gc
</code></pre></div><p>如果你不确定哪些东西会被删除，可以先把要删除的东西打印一下看看：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ nix-store --gc --print-dead
</code></pre></div><p>还有另外一个命令，它会删除<code>/nix/var/nix/profiles</code>下所有profile的老版本，可以用来清理你的系统：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ nix-collect-garbage -d
</code></pre></div><p>Nix的profile其实是可以放在任意位置的，但是垃圾回收的时候之后回收<code>/nix/var/nix/gcroots</code>下所指向的那些profile目录：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ ls -l /nix/var/nix/gcroots
auto
profiles -&gt; /nix/var/nix/profiles
</code></pre></div><h3 id=channel>Channel</h3><p>Nix的Channel存储了包的集合，可以通过命令添加Channel：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ nix-channel --add http://nixos.org/channels/nixpkgs-unstable
</code></pre></div><p>更新Channel:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ nix-channel --update
</code></pre></div><p>升级已有的包：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ nix-env -u <span class=s1>&#39;*&#39;</span>
</code></pre></div><p>此外，Nix还提供了很方便的工具让你把包及其依赖导出、导入以及通过SSH拷贝到另一台机器上：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ nix-store --export <span class=k>$(</span>nix-store -qR <span class=k>$(</span><span class=nb>type</span> -p firefox<span class=k>))</span> &gt; firefox.closure
$ nix-store --import &lt; firefox.closure
$ nix-copy-closure --to alice@itchy.example.org <span class=k>$(</span><span class=nb>type</span> -p firefox<span class=k>)</span>
</code></pre></div><h3 id=nix表达式>Nix表达式</h3><p>Nix的包是由Nix表达式描述的，它所使用的<a href=http://nixos.org/nix/manual/#idm47361539226272>Nix expression language</a>是一种支持惰性求值的纯函数式语言。下面是一个简单的<code>hello</code>包的描述：</p><div class=highlight><pre class=chroma><code class=language-nix data-lang=nix><span class=p>{</span> <span class=n>stdenv</span><span class=o>,</span> <span class=n>fetchurl</span><span class=o>,</span> <span class=n>perl</span> <span class=p>}:</span>

<span class=n>stdenv</span><span class=o>.</span><span class=n>mkDerivation</span> <span class=p>{</span>
  <span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;hello-2.1.v1&#34;</span><span class=p>;</span>
  <span class=n>builder</span> <span class=o>=</span> <span class=sr>./builder.sh</span><span class=p>;</span>
  <span class=n>src</span> <span class=o>=</span> <span class=n>fetchurl</span> <span class=p>{</span>
    <span class=n>url</span> <span class=o>=</span> <span class=sd>ftp://ftp.nluug.nl/pub/gnu/hello/hello-2.1.1.tar.gz</span><span class=p>;</span>
    <span class=n>md5</span> <span class=o>=</span> <span class=s2>&#34;70c9ccvf9fac07f762c24f2df2290784d&#34;</span><span class=p>;</span>
  <span class=p>};</span>
  <span class=k>inherit</span> <span class=n>perl</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>这个描述其实就是一个函数，<code>{stdenv, fetchurl, perl}</code>是函数的参数，表示构建这个包需要什么东西，<code>stdenv</code>提供了一个标准的构建环境，<code>fetchurl</code>通过url抓取一个文件，而<code>perl</code>是Perl的解释器。<code>mkDerivation</code>是<code>stdenv</code>提供的一个函数，它通过一个属性集合来构建一个包。<code>mkDerivation</code>的参数也就是后面花括弧括起来的那部分是一个集合，描述了这个包的属性，如名字、源代码、以及所需的解释器，其中的<code>builder</code>表示构建这个包的脚本：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>source</span> <span class=nv>$stdenv</span>/setup

<span class=nv>PATH</span><span class=o>=</span><span class=nv>$perl</span>/bin:<span class=nv>$PATH</span>

tar xvfz <span class=nv>$src</span>
<span class=nb>cd</span> hello-*
./configure --prefix<span class=o>=</span><span class=nv>$out</span>
make <span class=m>5</span>
make install
</code></pre></div><p>更具体的Nix expression这里就不赘述，有兴趣的可以查看相关文档。</p><h3 id=总结>总结</h3><p>Nix是一个非常强大的包管理工具，它可以非常方便地解决包的依赖以及多版本共存的问题，对于那些没有包管理系统的语言（如C/C++）是一个比较好的选择；对于包管理很弱的语言（如Python）也能够提供一个更好的解决方法；对于涉及到多中语言的项目，能够以一种统一的方式来管理各种包，对开发者而言是一个非常好的工具。</p><p>此外，Nix所提供的包管理机制应该可以和Docker结合起来。比如本地开发的时候使用Nix，发布时将相关的包打包形成一个Docker镜像，实现<a href=http://martinfowler.com/bliki/ReproducibleBuild.html>可重现的构建</a>。</p><p>如果说Nix的缺点，那就是相比<code>apt</code>、<code>yum</code>、<code>pacman</code>、<code>homebrew</code>之类比较成熟的包管理器，它包的数量还比较少，特别是在Mac上，有很多包还是处于<code>broken</code>的状态。不过Nix的开发比较活跃，即使你现在还没有用它，也值得去关注一下。</p><p>最后说一句，Nix其实也<a href=http://nixos.org/wiki/Nix_impurities>不是真的纯函数式</a> :-)</p></p></article><aside class=comments><script src=https://utteranc.es/client.js repo=hanjianwei/hanjianwei.github.io issue-term=pathname label=✨💬✨comment theme=github-light crossorigin=anonymous async></script></aside></div></main><footer>&copy; 2013 - 2021 Jianwei Han.
<a href=https://www.github.com/hanjianwei/hanjianwei.github.io/tree/hugo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M278.9 511.5l-61-17.7c-6.4-1.8-10-8.5-8.2-14.9L346.2 8.7c1.8-6.4 8.5-10 14.9-8.2l61 17.7c6.4 1.8 10 8.5 8.2 14.9L293.8 503.3c-1.9 6.4-8.5 10.1-14.9 8.2zm-114-112.2 43.5-46.4c4.6-4.9 4.3-12.7-.8-17.2L117 256l90.6-79.7c5.1-4.5 5.5-12.3.8-17.2l-43.5-46.4c-4.5-4.8-12.1-5.1-17-.5L3.8 247.2c-5.1 4.7-5.1 12.8.0 17.5l144.1 135.1c4.9 4.6 12.5 4.4 17-.5zm327.2.6 144.1-135.1c5.1-4.7 5.1-12.8.0-17.5L492.1 112.1c-4.8-4.5-12.4-4.3-17 .5L431.6 159c-4.6 4.9-4.3 12.7.8 17.2L523 256l-90.6 79.7c-5.1 4.5-5.5 12.3-.8 17.2l43.5 46.4c4.5 4.9 12.1 5.1 17 .6z"/></svg></a><a href=https://www.github.com/hanjianwei><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8.0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8.0-21.5 4.9-32.3 14.6-51.8 45.3.0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8.0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9.0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2.0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8.0-73.5 38.7-73.5 82.6.0 87.8 80.4 101.3 150.4 101.3h48.2c70.3.0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8.0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg></a><a href=https://twitter.com/hanjianwei><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a><a href=mailto:blog@hanjianwei.com><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V4e2c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5.0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></svg></a><a title="PGP Key" href="https://pgp.mit.edu/pks/lookup?op=get&search=0x309B79EC85BB7488"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="key" class="svg-inline--fa fa-key fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M512 176.001C512 273.203 433.202 352 336 352c-11.22.0-22.19-1.062-32.827-3.069l-24.012 27.014A23.999 23.999.0 01261.223 384H224v40c0 13.255-10.745 24-24 24h-40v40c0 13.255-10.745 24-24 24H24c-13.255.0-24-10.745-24-24v-78.059c0-6.365 2.529-12.47 7.029-16.971l161.802-161.802C163.108 213.814 160 195.271 160 176 160 78.798 238.797.001 335.999.0 433.488-.001 512 78.511 512 176.001zM336 128c0 26.51 21.49 48 48 48s48-21.49 48-48-21.49-48-48-48-48 21.49-48 48z"/></svg></a><a href=/index.xml><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328.0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765.0 183.105.0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686.0 38.981.0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"/></svg></a></footer></div></body></html>