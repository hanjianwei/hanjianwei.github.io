<!doctype html><html lang=en-us><head><title>网件WNDR4300上安装配置OpenWrt - Stone Horse</title><meta http-equiv=x-ua-compatible content="ie=edge"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://hanjianwei.com/style.css></head><body><div class=container><header><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Archives</a></li><li><a href=/tags>Tags</a></li></ul></nav></header><main><div class=post><article><h1>网件WNDR4300上安装配置OpenWrt</h1><time>Dec 2, 2015</time><p><p>WNDR4300是对OpenWrt支持比较好的一款路由器：其内存和闪存都是128M，有比较好的ROM支持，是一个比较适合折腾的路由器。</p><h3 id=openwrt的安装配置>OpenWrt的安装、配置</h3><p>首先，下载WNDR4300的固件，OpenWrt的<a href=https://downloads.openwrt.org>下载页面</a>列出了不同版本的的固件，一般来说下载最新的release即可。
比如当前支持WNDR4300的最新固件是<a href=https://downloads.openwrt.org/chaos_calmer/15.05/ar71xx/nand/openwrt-15.05-ar71xx-nand-wndr4300-ubi-factory.img>Chaos Calmer 15.05</a>。在下载的时候需要注意，如果是第一次刷机，要下载factory固件；如果以前刷过OpenWrt，下载sysupgrade。</p><p>然后，进入路由器的web界面，找到「固件升级」，选择下载的包确定。重启后，路由器的系统就变成OpenWrt了。需要注意的是，重启后默认Wifi没有开启，按一下路由器上的Wifi开关即可。在电脑上，连上OpenWrt这个热点，浏览器打开<code>192.168.1.1</code>登录，用户名为root，没有密码。进入系统后，先进入「System → Administration」修改密码、添加SSH公钥等。</p><p>在web页面选择「Network → Interfaces」，对WAN口进行配置。然后进入「Network → Wifi」，设置SSID和Wifi密码。</p><h2 id=shadowsocks>Shadowsocks</h2><p>首先，在路由器上安装<a href=https://shadowsocks.org>shadowsocks</a>的客户端：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ opkg install http://openwrt-dist.sourceforge.net/releases/ar71xx/packages/shadowsocks-libev_2.4.1-1_ar71xx.ipk
</code></pre></div><p>安装时到shadowsock的<a href=http://openwrt-dist.sourceforge.net/releases/ar71xx/packages/>下载页面</a>确定软件的具体版本。如果你空间有限，也可以装<code>polarssl</code>版本。</p><p>编辑<code>/etc/shadowsock.json</code>，填上你shadowsock服务器的信息。</p><p>然后设置shadowsock自动启动：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ /etc/init.d/shadowsocks <span class=nb>enable</span>
$ /etc/init.d/shadowsocks start
</code></pre></div><p>你可以将自己系统的SOCKS Proxy设置为<code>192.168.1.1:1080</code>，测试下shadowsocks是否工作正常。如果工作正常，将<code>/etc/init.d/shadowsocks</code>文件中的<code>ss-local</code>换成<code>ss-redir</code>并重启shadowsocks，表示我们要用shadowsocks进行转发。</p><h3 id=dsn服务器设置>DSN服务器设置</h3><p>为了防止DNS污染，利用dnsmasq将<a href=https://github.com/gfwlist/gfwlist>gfwlist</a>中的域名用OpenDNS解析。OpenWrt自带的dnsmasq功能是有限制的，首先安装上完全版的dnsmasq，并安装ipset包:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ opkg remove dnsmasq <span class=o>&amp;&amp;</span> opkg install dnsmasq-full
$ opkg install ipset
</code></pre></div><p>我们创建一个名为gfw的ipset，并设置所有ipset中的IP都通过shadowsocks转发。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ ipset create gfw hash:ip
$ iptables -t nat -A PREROUTING -p tcp -m <span class=nb>set</span> --match-set gfw dst -j REDIRECT --to-port <span class=m>1079</span>
</code></pre></div><p>为了防止路由器重启时规则丢失，可以将上述规则写到<code>/etc/firewall.user</code>文件中。</p><p>然后利用<a href=https://github.com/cokebar/gfwlist2dnsmasq>gfwlist2dnsmasq</a>生成<code>dnsmasq_list.conf</code>文件，记得运行命令之前将<code>gfwlist2dnsmasq.py</code>中的<code>mydnsip</code>改成208.67.220.220，<code>mydnsport</code>改成443，<code>ipsetname</code>改成gfw。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ python gfwlist2dnsmasq.py
</code></pre></div><p>修改dnsmasq的配置文件<code>/etc/dnsmasq.conf</code>，在最后加上一句：</p><div class=highlight><pre class=chroma><code class=language-ini data-lang=ini><span class=na>conf-dir</span><span class=o>=</span><span class=s>/etc/dnsmasq.d</span>
</code></pre></div><p>最后将生成的<code>dnsmasq_list.conf</code>拷贝到<code>/etc/dnsmasq.d</code>中，重启dnsmasq：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ /etc/init.d/dnsmasq restart
</code></pre></div><p>搞定！</p></p></article><aside class=comments><script src=https://utteranc.es/client.js repo=hanjianwei/hanjianwei.github.io issue-term=pathname label=✨💬✨comment theme=github-light crossorigin=anonymous async></script></aside></div></main><footer>&copy; 2013 - 2020 Jianwei Han.
<a href=https://www.github.com/hanjianwei/hanjianwei.github.io/tree/hugo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M278.9 511.5l-61-17.7c-6.4-1.8-10-8.5-8.2-14.9L346.2 8.7c1.8-6.4 8.5-10 14.9-8.2l61 17.7c6.4 1.8 10 8.5 8.2 14.9L293.8 503.3c-1.9 6.4-8.5 10.1-14.9 8.2zm-114-112.2 43.5-46.4c4.6-4.9 4.3-12.7-.8-17.2L117 256l90.6-79.7c5.1-4.5 5.5-12.3.8-17.2l-43.5-46.4c-4.5-4.8-12.1-5.1-17-.5L3.8 247.2c-5.1 4.7-5.1 12.8.0 17.5l144.1 135.1c4.9 4.6 12.5 4.4 17-.5zm327.2.6 144.1-135.1c5.1-4.7 5.1-12.8.0-17.5L492.1 112.1c-4.8-4.5-12.4-4.3-17 .5L431.6 159c-4.6 4.9-4.3 12.7.8 17.2L523 256l-90.6 79.7c-5.1 4.5-5.5 12.3-.8 17.2l43.5 46.4c4.5 4.9 12.1 5.1 17 .6z"/></svg></a><a href=https://www.github.com/hanjianwei><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8.0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8.0-21.5 4.9-32.3 14.6-51.8 45.3.0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8.0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9.0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2.0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8.0-73.5 38.7-73.5 82.6.0 87.8 80.4 101.3 150.4 101.3h48.2c70.3.0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8.0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg></a><a href=https://twitter.com/hanjianwei><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a><a href=mailto:blog@hanjianwei.com><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V4e2c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5.0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></svg></a><a title="PGP Key" href="https://pgp.mit.edu/pks/lookup?op=get&search=0x309B79EC85BB7488"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="key" class="svg-inline--fa fa-key fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M512 176.001C512 273.203 433.202 352 336 352c-11.22.0-22.19-1.062-32.827-3.069l-24.012 27.014A23.999 23.999.0 01261.223 384H224v40c0 13.255-10.745 24-24 24h-40v40c0 13.255-10.745 24-24 24H24c-13.255.0-24-10.745-24-24v-78.059c0-6.365 2.529-12.47 7.029-16.971l161.802-161.802C163.108 213.814 160 195.271 160 176 160 78.798 238.797.001 335.999.0 433.488-.001 512 78.511 512 176.001zM336 128c0 26.51 21.49 48 48 48s48-21.49 48-48-21.49-48-48-48-48 21.49-48 48z"/></svg></a><a href=/index.xml><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328.0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765.0 183.105.0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686.0 38.981.0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"/></svg></a></footer></div></body></html>